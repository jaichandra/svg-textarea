<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="fontmetrics.html">

<dom-module id="svg-textarea">
  <template>
    <style>
       :host {
        display: flex;
        align-items: left;
        font-size: 50px;
        position: relative;
      }

      #textarea {

        /* border: none; */
        overflow: auto;
        position: absolute;
        min-width: 20px;
        /* min-height: 25px; */
        /* DO NOT EDIT 
          padding required to show edit cursor when mouse is on the top left corner
        */
        padding: 2px;
        /* *********** */
        resize: none;
        /*** DO NOT EDIT ***/
        /* Chrome; W3C standard */
        white-space: pre-wrap;
        /* *************** */
      }
      /* #textarea p {
        line-height: 0px;
      } */
      /* IE11 fix */
      /* #textarea p:first-child {
        margin-top: 1.9rem;
      } */
      /* IE11 fix (https://stackoverflow.com/questions/2057881/avoid-ie-contenteditable-element-to-create-paragraphs-on-enter-key) */

      #textarea:focus {
        border: 0 none #FFF;
        overflow: hidden;
        outline: none;
      }

      #svgcontent {
        overflow: visible;
        padding: 2px;
      }

      #svgcontent tspan {
        white-space: pre;
      }
    </style>
    <div id="textarea" contenteditable="true" on-blur="handleBlur" on-click="makeEditable"></div>

    <svg id="svgcontent" width="100%" height="100%" style="outline: 1px solid red;">
      <text id="svgtext" x="0" y="0"></text>
    </svg>
  </template>


  <script>
    // function fontmetricsLoaded() {
    // console.log('fontmetricsLoaded');

    /**
    * `svg-textarea`
    * SVG textarea element
    *
    * @customElement
    * @polymer
    * @demo demo/index.html
    */
    class SvgTextarea extends Polymer.Element {
      static get is() { return 'svg-textarea'; }
      static get properties() {
        return {
          svg: {
            type: String
          },
          lineHeight: {
            value: 0 // set initial vertical position
          },
          baseline: {
            value: 0
          },
          metrics: {
            value: {}
          }

        };
      }

      connectedCallback() {
        super.connectedCallback();

        this.metrics = FontMetrics({
          fontFamily: 'Roboto',
          // Optional (defaults)
          fontWeight: 'normal',
          fontSize: 50,
          origin: 'top'
        })
        console.log('metrics', this.metrics);
        this.$.textarea.addEventListener("paste", function (e) {
          e.preventDefault();
          var text = e.clipboardData.getData("text/plain");
          document.execCommand("insertHTML", false, text);
        });

        // var o = this;
        // this.$.textarea.addEventListener("keypress", function (e) {
        //   if (e.which == 13) {
        //     // e.preventDefault();
        //     // let r = document.getSelection().getRangeAt(0);
        //     // let node = r.createContextualFragment("<br>");
        //     // r.insertNode(node);
        //     // // Move the caret after the BR
        //     // var range = document.createRange();
        //     // var sel = window.getSelection();
        //     // range.setStart(e.target.childNodes[1], 0);
        //     // range.collapse(true);
        //     // sel.removeAllRanges();
        //     // sel.addRange(range);
        //     // console.log(o.$.textarea.innerHTML);
        //   }
        // });

        // this.$.textarea.innerHTML = '<div></div>';
      }

      getBrowser() {
        var sBrowser, sUsrAg = navigator.userAgent;

        if (sUsrAg.indexOf("Chrome") > -1) {
          sBrowser = "Google Chrome";
        } else if (sUsrAg.indexOf("Safari") > -1) {
          sBrowser = "Apple Safari";
        } else if (sUsrAg.indexOf("Opera") > -1) {
          sBrowser = "Opera";
        } else if (sUsrAg.indexOf("Firefox") > -1) {
          sBrowser = "Mozilla Firefox";
        } else if (sUsrAg.indexOf("MSIE") > -1 || sUsrAg.indexOf("Mozilla/5.0") > -1) {
          sBrowser = "Microsoft Internet Explorer";
        }
        return sBrowser;
      }

      isFirefox() {
        return this.getBrowser() === 'Mozilla Firefox'
      }
      isIE() {
        return this.getBrowser() === 'Microsoft Internet Explorer'
      }

      handleBlur(e) {
        // console.log(this.$.textarea.textContent);
        // console.log(this.$.textarea.innerText);
        // console.log(this.$.textarea.innerHTML);
        this.parseText();
      }

      parseText() {
        // handle IE bug where <p> tags are added instead of <br>
        // if (this.isIE()) {
        //   let $newcontent = this.$.textarea.innerHTML.replace(/<p[^>]*?>/g, "");
        //   $newcontent = $newcontent.replace(/<\/p>/g, "<br>");
        //   this.$.textarea.innerHTML = $newcontent;
        // }
        // ======================================================

        this.showTextarea(false);

        this.clearSVG();

        // Calculate the baseline for first tspan
        this.baseline = Math.abs(this.metrics.baseline) * this.metrics.fontSize;
        /////////////////

        let formattedContent = this.ApplyLineBreaks();
        // console.log(formattedContent);

        let textLines = formattedContent.split('<br>');
        let counter = 0;
        textLines.map(key => {
          if (key !== '') {
            this.addText(key, counter === 0 ? true : false);
          }
          counter++;
        });
      }

      addText(node, isFirst) {
        // get text value from the input
        var myText = node;
        // create a new text node to add to the SVG block
        var newText = document.createElementNS("http://www.w3.org/2000/svg", "tspan");

        newText.appendChild(document.createTextNode(myText));
        this.$.svgtext.appendChild(newText);

        this.lineHeight = this.lineHeight || newText.getClientRects()[0].height;

        // debugger;
        // newText.setAttributeNS(null, "alignment-baseline", "text-before-edge");
        newText.setAttributeNS(null, "x", "0");
        // newText.setAttributeNS(null, "dy", (isFirst && !this.isFirefox()) ? this.baseline : this.lineHeight);
        newText.setAttributeNS(null, "dy", (isFirst) ? this.baseline : this.lineHeight);
        // add the text node to the SVG element
        // debugger;
        // empty the form fieldset & give it focus
        // document.getElementById('blabla').value = '';
        // document.getElementById('blabla').focus();
      }

      makeEditable() {
        // console.log(this.$.textarea.innerHTML);
        this.showTextarea(true);
        this.clearSVG();
        // this.$.textarea.focus();
      }

      showTextarea(flag) {
        this.$.textarea.style.opacity = flag ? 1 : 0;
      }

      clearSVG() {
        while (this.$.svgtext.lastChild) {
          this.$.svgtext.removeChild(this.$.svgtext.lastChild);
        }
      }

      ApplyLineBreaks() {
        var oTextarea = this.$.textarea;
        // if (oTextarea.wrap) {
        //   oTextarea.setStyle("word-wrap", "pre");
        // }
        // else {
        // oTextarea.style.whiteSpace = "pre";
        // var newArea = oTextarea.cloneNode(true);
        // newArea.innerText = oTextarea.innerText;
        // oTextarea.parentNode.replaceChild(newArea, oTextarea);
        // oTextarea = newArea;
        // }

        var strRawValue = oTextarea.innerText;
        var nEmptyWidth = oTextarea.scrollWidth;

        oTextarea.style.whiteSpace = "pre";
        oTextarea.innerText = "";
        var nLastWrappingIndex = -1;

        function testBreak(strTest) {
          oTextarea.innerText = strTest;
          return oTextarea.scrollWidth > nEmptyWidth;
        }
        function findNextBreakLength(strSource, nLeft, nRight) {
          var nCurrent;
          if (typeof (nLeft) == 'undefined') {
            nLeft = 0;
            nRight = -1;
            nCurrent = 64;
          }
          else {
            if (nRight == -1)
              nCurrent = nLeft * 2;
            else if (nRight - nLeft <= 1)
              return Math.max(2, nRight);
            else
              nCurrent = nLeft + (nRight - nLeft) / 2;
          }
          var strTest = strSource.substr(0, nCurrent);
          var bLonger = testBreak(strTest);
          if (bLonger)
            nRight = nCurrent;
          else {
            if (nCurrent >= strSource.length)
              return null;
            nLeft = nCurrent;
          }
          return findNextBreakLength(strSource, nLeft, nRight);
        }

        var i = 0, j;
        var strNewValue = "";
        while (i < strRawValue.length) {
          var breakOffset = findNextBreakLength(strRawValue.substr(i));
          if (breakOffset === null) {
            strNewValue += strRawValue.substr(i);
            break;
          }
          nLastWrappingIndex = -1;
          var nLineLength = breakOffset - 1;
          for (j = nLineLength - 1; j >= 0; j--) {
            var curChar = strRawValue.charAt(i + j);
            if (curChar == ' ' || curChar == '-' || curChar == '+') {
              nLineLength = j + 1;
              break;
            }
          }
          strNewValue += strRawValue.substr(i, nLineLength) + "\n";
          i += nLineLength;
        }
        oTextarea.style.whiteSpace = "pre-wrap";
        return strNewValue.replace(new RegExp("\\n", "g"), "<br>");
        // oTextarea.value = strNewValue;
        // oTextarea.setAttribute("wrap", "");
        // document.getElementById("pnlPreview").innerHTML = oTextarea.value.replace(new RegExp("\\n", "g"), "<br />");
      }
    }

    window.customElements.define(SvgTextarea.is, SvgTextarea);

    // }
  </script>
</dom-module>